{% extends "base.html" %}

{% block title %}Zarządzanie Segmentami - Topologia{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <h2><i class="fas fa-route"></i> Zarządzanie Segmentami</h2>
            <p class="text-muted">Segmenty rurociągu łączą sprzęt poprzez porty i węzły</p>
        </div>
    </div>

    <!-- Alert messages -->
    <div id="alertContainer"></div>

    <!-- Search and Add Section -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="input-group">
                <input type="text" id="searchSegments" class="form-control" placeholder="Szukaj segmentów...">
                <div class="input-group-append">
                    <button class="btn btn-outline-secondary" type="button">
                        <i class="fas fa-search"></i>
                    </button>
                </div>
            </div>
        </div>
        <div class="col-md-6 text-right">
            <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#addSegmentModal">
                <i class="fas fa-plus"></i> Dodaj Segment
            </button>
            <button type="button" class="btn btn-info" onclick="refreshSegments()">
                <i class="fas fa-sync-alt"></i> Odśwież
            </button>
        </div>
    </div>

    <!-- Segments Table -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Lista Segmentów</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table id="segmentsTable" class="table table-striped table-hover">
                            <thead class="thead-dark">
                                <tr>
                                    <th>ID</th>
                                    <th>Nazwa</th>
                                    <th>Długość (m)</th>
                                    <th>Średnica (mm)</th>
                                    <th>Materiał</th>
                                    <th>Typ Rurociągu</th>
                                    <th>Sprzęt Źródłowy</th>
                                    <th>Sprzęt Docelowy</th>
                                    <th>Zawór</th>
                                    <th>Status</th>
                                    <th>Akcje</th>
                                </tr>
                                <tr id="filterRow">
                                    <th><input type="text" class="form-control form-control-sm" placeholder="ID"></th>
                                    <th><input type="text" class="form-control form-control-sm" placeholder="Nazwa"></th>
                                    <th><input type="text" class="form-control form-control-sm" placeholder="Długość"></th>
                                    <th><input type="text" class="form-control form-control-sm" placeholder="Średnica"></th>
                                    <th><input type="text" class="form-control form-control-sm" placeholder="Materiał"></th>
                                    <th><input type="text" class="form-control form-control-sm" placeholder="Typ"></th>
                                    <th><input type="text" class="form-control form-control-sm" placeholder="Źródło"></th>
                                    <th><input type="text" class="form-control form-control-sm" placeholder="Cel"></th>
                                    <th><input type="text" class="form-control form-control-sm" placeholder="Zawór"></th>
                                    <th>
                                        <select class="form-control form-control-sm">
                                            <option value="">Wszystkie</option>
                                            <option value="aktywny">Aktywny</option>
                                            <option value="nieaktywny">Nieaktywny</option>
                                            <option value="konserwacja">Konserwacja</option>
                                        </select>
                                    </th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody id="segmentsTableBody">
                                <!-- Dynamic content -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Segment Modal -->
<div class="modal fade" id="addSegmentModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Dodaj Nowy Segment</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <form id="addSegmentForm">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="addNazwa">Nazwa Segmentu *</label>
                                <input type="text" class="form-control" id="addNazwa" name="nazwa" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="addTypRurociagu">Typ Rurociągu</label>
                                <input type="text" class="form-control" id="addTypRurociagu" name="typ_rurociagu">
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="addDlugosc">Długość (m)</label>
                                <input type="number" step="0.01" class="form-control" id="addDlugosc" name="dlugosc">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="addSrednica">Średnica (mm)</label>
                                <input type="number" step="0.1" class="form-control" id="addSrednica" name="srednica">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="addMaterial">Materiał</label>
                                <input type="text" class="form-control" id="addMaterial" name="material">
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="addSprzetZrodlowy">Sprzęt Źródłowy *</label>
                                <select class="form-control" id="addSprzetZrodlowy" name="sprzet_zrodlowy_id" required>
                                    <option value="">Wybierz sprzęt źródłowy</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="addSprzetDocelowy">Sprzęt Docelowy *</label>
                                <select class="form-control" id="addSprzetDocelowy" name="sprzet_docelowy_id" required>
                                    <option value="">Wybierz sprzęt docelowy</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="addPortZrodlowy">Port Źródłowy *</label>
                                <select class="form-control" id="addPortZrodlowy" name="port_zrodlowy_id" required>
                                    <option value="">Wybierz port źródłowy</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="addPortDocelowy">Port Docelowy *</label>
                                <select class="form-control" id="addPortDocelowy" name="port_docelowy_id" required>
                                    <option value="">Wybierz port docelowy</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="addZawor">Zawór *</label>
                                <select class="form-control" id="addZawor" name="zawor_id" required>
                                    <option value="">Wybierz zawór</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="addStatus">Status</label>
                                <select class="form-control" id="addStatus" name="status">
                                    <option value="aktywny">Aktywny</option>
                                    <option value="nieaktywny">Nieaktywny</option>
                                    <option value="konserwacja">Konserwacja</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="addOpis">Opis</label>
                        <textarea class="form-control" id="addOpis" name="opis" rows="3"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Anuluj</button>
                    <button type="submit" class="btn btn-primary">Dodaj Segment</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Segment Modal -->
<div class="modal fade" id="editSegmentModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edytuj Segment</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <form id="editSegmentForm">
                <input type="hidden" id="editId" name="id">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="editNazwa">Nazwa Segmentu *</label>
                                <input type="text" class="form-control" id="editNazwa" name="nazwa" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="editTypRurociagu">Typ Rurociągu</label>
                                <input type="text" class="form-control" id="editTypRurociagu" name="typ_rurociagu">
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="editDlugosc">Długość (m)</label>
                                <input type="number" step="0.01" class="form-control" id="editDlugosc" name="dlugosc">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="editSrednica">Średnica (mm)</label>
                                <input type="number" step="0.1" class="form-control" id="editSrednica" name="srednica">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="editMaterial">Materiał</label>
                                <input type="text" class="form-control" id="editMaterial" name="material">
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="editSprzetZrodlowy">Sprzęt Źródłowy *</label>
                                <select class="form-control" id="editSprzetZrodlowy" name="sprzet_zrodlowy_id" required>
                                    <option value="">Wybierz sprzęt źródłowy</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="editSprzetDocelowy">Sprzęt Docelowy *</label>
                                <select class="form-control" id="editSprzetDocelowy" name="sprzet_docelowy_id" required>
                                    <option value="">Wybierz sprzęt docelowy</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="editPortZrodlowy">Port Źródłowy *</label>
                                <select class="form-control" id="editPortZrodlowy" name="port_zrodlowy_id" required>
                                    <option value="">Wybierz port źródłowy</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="editPortDocelowy">Port Docelowy *</label>
                                <select class="form-control" id="editPortDocelowy" name="port_docelowy_id" required>
                                    <option value="">Wybierz port docelowy</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="editZawor">Zawór *</label>
                                <select class="form-control" id="editZawor" name="zawor_id" required>
                                    <option value="">Wybierz zawór</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="editStatus">Status</label>
                                <select class="form-control" id="editStatus" name="status">
                                    <option value="aktywny">Aktywny</option>
                                    <option value="nieaktywny">Nieaktywny</option>
                                    <option value="konserwacja">Konserwacja</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="editOpis">Opis</label>
                        <textarea class="form-control" id="editOpis" name="opis" rows="3"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Anuluj</button>
                    <button type="submit" class="btn btn-primary">Zapisz Zmiany</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Details Modal -->
<div class="modal fade" id="detailsSegmentModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Szczegóły Segmentu</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body" id="detailsContent">
                <!-- Dynamic content -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Zamknij</button>
            </div>
        </div>
    </div>
</div>

<script>
$(document).ready(function() {
    loadSegments();
    loadDropdownData();
    
    // Search functionality
    $('#searchSegments').on('keyup', function() {
        filterTable();
    });
    
    // Filter row inputs
    $('#filterRow input, #filterRow select').on('keyup change', function() {
        filterTable();
    });
    
    // Form submissions
    $('#addSegmentForm').on('submit', function(e) {
        e.preventDefault();
        addSegment();
    });
    
    $('#editSegmentForm').on('submit', function(e) {
        e.preventDefault();
        updateSegment();
    });
    
    // Equipment change handlers for ports
    $('#addSprzetZrodlowy, #editSprzetZrodlowy').on('change', function() {
        loadPortsForEquipment($(this).val(), $(this).attr('id').includes('add') ? '#addPortZrodlowy' : '#editPortZrodlowy');
    });
    
    $('#addSprzetDocelowy, #editSprzetDocelowy').on('change', function() {
        loadPortsForEquipment($(this).val(), $(this).attr('id').includes('add') ? '#addPortDocelowy' : '#editPortDocelowy');
    });
});

function loadSegments() {
    $.get('/topology/api/segmenty', function(data) {
        let tbody = $('#segmentsTableBody');
        tbody.empty();
        
        if (data.data && data.data.length > 0) {
            data.data.forEach(function(segment) {
                let row = `
                    <tr>
                        <td>${segment.id}</td>
                        <td>${segment.nazwa || ''}</td>
                        <td>${segment.dlugosc || ''}</td>
                        <td>${segment.srednica || ''}</td>
                        <td>${segment.material || ''}</td>
                        <td>${segment.typ_rurociagu || ''}</td>
                        <td>${segment.sprzet_zrodlowy_nazwa || ''}</td>
                        <td>${segment.sprzet_docelowy_nazwa || ''}</td>
                        <td>${segment.zawor_nazwa || ''}</td>
                        <td>
                            <span class="badge badge-${getStatusBadgeClass(segment.status)}">${segment.status || 'nieznany'}</span>
                        </td>
                        <td>
                            <div class="btn-group" role="group">
                                <button class="btn btn-sm btn-info" onclick="showSegmentDetails(${segment.id})" title="Szczegóły">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="btn btn-sm btn-warning" onclick="editSegment(${segment.id})" title="Edytuj">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="deleteSegment(${segment.id})" title="Usuń">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
                tbody.append(row);
            });
        } else {
            tbody.append('<tr><td colspan="11" class="text-center text-muted">Brak segmentów do wyświetlenia</td></tr>');
        }
    }).fail(function() {
        showAlert('Błąd podczas ładowania segmentów', 'danger');
    });
}

function loadDropdownData() {
    // Load equipment
    $.get('/topology/api/sprzet', function(data) {
        let options = '<option value="">Wybierz sprzęt</option>';
        if (data.data) {
            data.data.forEach(function(eq) {
                options += `<option value="${eq.id}">${eq.nazwa}</option>`;
            });
        }
        $('#addSprzetZrodlowy, #addSprzetDocelowy, #editSprzetZrodlowy, #editSprzetDocelowy').html(options);
    });
    
    // Load valves
    $.get('/topology/api/zawory', function(data) {
        let options = '<option value="">Wybierz zawór</option>';
        if (data.data) {
            data.data.forEach(function(valve) {
                options += `<option value="${valve.id}">${valve.nazwa}</option>`;
            });
        }
        $('#addZawor, #editZawor').html(options);
    });
}

function loadPortsForEquipment(equipmentId, targetSelect) {
    if (!equipmentId) {
        $(targetSelect).html('<option value="">Wybierz port</option>');
        return;
    }
    
    $.get(`/topology/api/sprzet/${equipmentId}/porty`, function(data) {
        let options = '<option value="">Wybierz port</option>';
        if (data.data) {
            data.data.forEach(function(port) {
                options += `<option value="${port.id}">${port.nazwa}</option>`;
            });
        }
        $(targetSelect).html(options);
    });
}

function addSegment() {
    let formData = $('#addSegmentForm').serialize();
    
    $.post('/topology/api/segmenty', formData, function(data) {
        if (data.success) {
            $('#addSegmentModal').modal('hide');
            $('#addSegmentForm')[0].reset();
            loadSegments();
            showAlert('Segment został dodany pomyślnie', 'success');
        } else {
            showAlert(data.message || 'Błąd podczas dodawania segmentu', 'danger');
        }
    }).fail(function() {
        showAlert('Błąd podczas dodawania segmentu', 'danger');
    });
}

function editSegment(id) {
    $.get(`/topology/api/segmenty/${id}`, function(data) {
        if (data.data) {
            let segment = data.data;
            $('#editId').val(segment.id);
            $('#editNazwa').val(segment.nazwa);
            $('#editTypRurociagu').val(segment.typ_rurociagu);
            $('#editDlugosc').val(segment.dlugosc);
            $('#editSrednica').val(segment.srednica);
            $('#editMaterial').val(segment.material);
            $('#editSprzetZrodlowy').val(segment.sprzet_zrodlowy_id);
            $('#editSprzetDocelowy').val(segment.sprzet_docelowy_id);
            $('#editPortZrodlowy').val(segment.port_zrodlowy_id);
            $('#editPortDocelowy').val(segment.port_docelowy_id);
            $('#editZawor').val(segment.zawor_id);
            $('#editStatus').val(segment.status);
            $('#editOpis').val(segment.opis);
            
            // Load ports for selected equipment
            if (segment.sprzet_zrodlowy_id) {
                loadPortsForEquipment(segment.sprzet_zrodlowy_id, '#editPortZrodlowy');
            }
            if (segment.sprzet_docelowy_id) {
                loadPortsForEquipment(segment.sprzet_docelowy_id, '#editPortDocelowy');
            }
            
            $('#editSegmentModal').modal('show');
        }
    }).fail(function() {
        showAlert('Błąd podczas ładowania danych segmentu', 'danger');
    });
}

function updateSegment() {
    let id = $('#editId').val();
    let formData = $('#editSegmentForm').serialize();
    
    $.ajax({
        url: `/topology/api/segmenty/${id}`,
        type: 'PUT',
        data: formData,
        success: function(data) {
            if (data.success) {
                $('#editSegmentModal').modal('hide');
                loadSegments();
                showAlert('Segment został zaktualizowany pomyślnie', 'success');
            } else {
                showAlert(data.message || 'Błąd podczas aktualizacji segmentu', 'danger');
            }
        },
        error: function() {
            showAlert('Błąd podczas aktualizacji segmentu', 'danger');
        }
    });
}

function deleteSegment(id) {
    if (confirm('Czy na pewno chcesz usunąć ten segment?')) {
        $.ajax({
            url: `/topology/api/segmenty/${id}`,
            type: 'DELETE',
            success: function(data) {
                if (data.success) {
                    loadSegments();
                    showAlert('Segment został usunięty pomyślnie', 'success');
                } else {
                    showAlert(data.message || 'Błąd podczas usuwania segmentu', 'danger');
                }
            },
            error: function() {
                showAlert('Błąd podczas usuwania segmentu', 'danger');
            }
        });
    }
}

function showSegmentDetails(id) {
    $.get(`/topology/api/segmenty/${id}`, function(data) {
        if (data.data) {
            let segment = data.data;
            let content = `
                <div class="row">
                    <div class="col-md-6">
                        <h6>Informacje podstawowe</h6>
                        <table class="table table-sm">
                            <tr><td><strong>ID:</strong></td><td>${segment.id}</td></tr>
                            <tr><td><strong>Nazwa:</strong></td><td>${segment.nazwa || '-'}</td></tr>
                            <tr><td><strong>Typ rurociągu:</strong></td><td>${segment.typ_rurociagu || '-'}</td></tr>
                            <tr><td><strong>Status:</strong></td><td><span class="badge badge-${getStatusBadgeClass(segment.status)}">${segment.status || 'nieznany'}</span></td></tr>
                        </table>
                        
                        <h6>Parametry techniczne</h6>
                        <table class="table table-sm">
                            <tr><td><strong>Długość:</strong></td><td>${segment.dlugosc || '-'} m</td></tr>
                            <tr><td><strong>Średnica:</strong></td><td>${segment.srednica || '-'} mm</td></tr>
                            <tr><td><strong>Materiał:</strong></td><td>${segment.material || '-'}</td></tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <h6>Połączenia</h6>
                        <table class="table table-sm">
                            <tr><td><strong>Sprzęt źródłowy:</strong></td><td>${segment.sprzet_zrodlowy_nazwa || '-'}</td></tr>
                            <tr><td><strong>Port źródłowy:</strong></td><td>${segment.port_zrodlowy_nazwa || '-'}</td></tr>
                            <tr><td><strong>Sprzęt docelowy:</strong></td><td>${segment.sprzet_docelowy_nazwa || '-'}</td></tr>
                            <tr><td><strong>Port docelowy:</strong></td><td>${segment.port_docelowy_nazwa || '-'}</td></tr>
                            <tr><td><strong>Zawór:</strong></td><td>${segment.zawor_nazwa || '-'}</td></tr>
                        </table>
                        
                        ${segment.opis ? `<h6>Opis</h6><p>${segment.opis}</p>` : ''}
                    </div>
                </div>
            `;
            $('#detailsContent').html(content);
            $('#detailsSegmentModal').modal('show');
        }
    }).fail(function() {
        showAlert('Błąd podczas ładowania szczegółów segmentu', 'danger');
    });
}

function refreshSegments() {
    loadSegments();
    showAlert('Lista segmentów została odświeżona', 'info');
}

function filterTable() {
    let searchValue = $('#searchSegments').val().toLowerCase();
    let filters = {};
    
    // Get filter values
    $('#filterRow input, #filterRow select').each(function() {
        let value = $(this).val().toLowerCase();
        if (value) {
            let columnIndex = $(this).parent().index();
            filters[columnIndex] = value;
        }
    });
    
    // Filter rows
    $('#segmentsTableBody tr').each(function() {
        let row = $(this);
        let show = true;
        
        // Search filter
        if (searchValue) {
            let rowText = row.text().toLowerCase();
            if (rowText.indexOf(searchValue) === -1) {
                show = false;
            }
        }
        
        // Column filters
        Object.keys(filters).forEach(function(columnIndex) {
            let cellText = row.find('td').eq(columnIndex).text().toLowerCase();
            if (cellText.indexOf(filters[columnIndex]) === -1) {
                show = false;
            }
        });
        
        row.toggle(show);
    });
}

function getStatusBadgeClass(status) {
    switch(status) {
        case 'aktywny': return 'success';
        case 'nieaktywny': return 'secondary';
        case 'konserwacja': return 'warning';
        default: return 'light';
    }
}

function showAlert(message, type) {
    let alertHtml = `
        <div class="alert alert-${type} alert-dismissible fade show" role="alert">
            ${message}
            <button type="button" class="close" data-dismiss="alert">
                <span aria-hidden="true">&times;</span>
            </button>
        </div>
    `;
    $('#alertContainer').html(alertHtml);
    
    // Auto-hide after 5 seconds
    setTimeout(function() {
        $('.alert').alert('close');
    }, 5000);
}
</script>
{% endblock %}
